#!/bin/bash

BUILD_DIR=$1
CACHE_DIR=$2
ENV_FILE=$3

# Maxmind GeoIP Library and Database

LIBMAXMIND_DIST_URL="https://github.com/maxmind/libmaxminddb/releases/download/1.1.4/libmaxminddb-1.1.4.tar.gz"

mkdir -p $CACHE_DIR/.geoip
mkdir -p "$BUILD_DIR/vendor"
mkdir -p "$BUILD_DIR/vendor/share/"

echo "-----> Installing libmaxminddb"

if [ ! -d $CACHE_DIR/.geoip/libmaxminddb ]; then
  # Download and build libmaxminddb
  cd "$CACHE_DIR/.geoip"

  echo "       Downloading libmaxminddb"
  curl -s -L -o libmaxminddb-1.1.4.tar.gz $LIBMAXMIND_DIST_URL > /dev/null
  tar -zxvf libmaxminddb-1.1.4.tar.gz > /dev/null
  cd libmaxminddb-1.1.4

  echo "       Configuring and building libmaxminddb"
  ./configure --prefix="$CACHE_DIR/.geoip/libmaxminddb" > /dev/null
  make > /dev/null
  make check > /dev/null
  make install > /dev/null

  cd $HOME
else
  echo "       $CACHE_DIR/.geoip/libmaxminddb already cached"
fi

# Copy libmaxminddb files to build dir
cp -R $CACHE_DIR/.geoip/libmaxminddb $BUILD_DIR/vendor

GEOLITECITY_URL="http://geolite.maxmind.com/download/geoip/database/GeoLite2-City.mmdb.gz"
GEOLITECITY_FILE="GeoLite2-City.mmdb"

if [ ! -f $CACHE_DIR/.geoip/$GEOLITECITY_FILE ]; then
  echo "       Downloading  $GEOLITECITY_FILE"

  cd "$CACHE_DIR/.geoip"

  curl -s -L -o ${GEOLITECITY_FILE}.gz $GEOLITECITY_URL
  gunzip ${GEOLITECITY_FILE}.gz > /dev/null

  cd $HOME
else
  echo "       $GEOLITECITY_FILE already cached"
fi

cp "$CACHE_DIR/.geoip/$GEOLITECITY_FILE" "$BUILD_DIR/vendor/share/$GEOLITECITY_FILE"
GEOIP_DB_PATH="\$HOME/vendor/share/$GEOLITECITY_FILE"

PROFILE_PATH="$BUILD_DIR/.profile.d/libmaxminddb.sh"
mkdir -p $(dirname $PROFILE_PATH)
echo "export GEOIP_DB_PATH=\"$GEOIP_DB_PATH\"" >> $PROFILE_PATH
echo "export PATH=\"\$PATH:vendor/libmaxminddb/bin\"" >> $PROFILE_PATH
echo "export LD_LIBRARY_PATH=\"\$LD_LIBRARY_PATH:vendor/libmaxminddb/include:vendor/libmaxminddb/lib\"" >> $PROFILE_PATH
echo "export LIBRARY_PATH=\"\$LIBRARY_PATH:vendor/libmaxminddb/include:vendor/libmaxminddb/lib\"" >> $PROFILE_PATH
echo "export INCLUDE_PATH=\"\$INCLUDE_PATH:vendor/libmaxminddb/include:vendor/libmaxminddb/lib\"" >> $PROFILE_PATH
echo "export CPATH=\"-Ivendor/libmaxminddb/include -Ivendor/libmaxminddb/lib\"" >> $PROFILE_PATH
echo "export CPPFLAGS=\"-Ivendor/libmaxminddb/include\"" >> $PROFILE_PATH
echo "export LDFLAGS=\"-Lvendor/libmaxminddb/lib\"" >> $PROFILE_PATH

export CPPFLAGS="-Ivendor/libmaxminddb/include"
export LDFLAGS="-Lvendor/libmaxminddb/lib"

# echo "       TESTING gem"
# LD_LIBRARY_PATH="$BUILD_DIR/vendor/libmaxminddb/include:$BUILD_DIR/vendor/libmaxminddb/lib"
gem install maxmind_geoip2

cat $PROFILE_PATH


echo "       Exporting \$GEOIP_DB_PATH=$GEOIP_DB_PATH"

#!/bin/bash

BUILD_DIR=$1
CACHE_DIR=$2
ENV_FILE=$3

# Maxmind GeoIP Library and Database

ROOT_DIR=$(pwd)
LIBMAXMIND_DIST_URL="https://github.com/maxmind/libmaxminddb/releases/download/1.1.4/libmaxminddb-1.1.4.tar.gz"
VENDOR_DIR="vendor"
APP_GEOIP="\$HOME/$VENDOR_DIR"

mkdir -p $CACHE_DIR/.geoip
mkdir -p "$BUILD_DIR/$VENDOR_DIR"
mkdir -p "$BUILD_DIR/$VENDOR_DIR/share/"

echo "-----> Installing libmaxminddb"

if [ ! -d $CACHE_DIR/.geoip/libmaxminddb ]; then
  # Download and build libmaxminddb
  cd "$CACHE_DIR/.geoip"

  echo "       Downloading libmaxminddb"
  curl -s -L -o libmaxminddb-1.1.4.tar.gz $LIBMAXMIND_DIST_URL > /dev/null
  tar -zxvf libmaxminddb-1.1.4.tar.gz > /dev/null
  cd libmaxminddb-1.1.4

  echo "       Configuring and building libmaxminddb"
  ./configure --prefix="$CACHE_DIR/.geoip/libmaxminddb" > /dev/null
  make > /dev/null
  make check > /dev/null
  make install > /dev/null

  cd $ROOT_DIR
else
  echo "       $CACHE_DIR/.geoip/libmaxminddb already cached"
fi

# Copy libmaxminddb files to build dir
cp -R $CACHE_DIR/.geoip/libmaxminddb $BUILD_DIR/$VENDOR_DIR

GEOLITECITY_URL="http://geolite.maxmind.com/download/geoip/database/GeoLite2-City.mmdb.gz"
GEOLITECITY_FILE="GeoLite2-City.mmdb"

if [ ! -f $CACHE_DIR/.geoip/$GEOLITECITY_FILE ]; then
  echo "       Downloading  $GEOLITECITY_FILE"

  cd "$CACHE_DIR/.geoip"

  curl -s -L -o ${GEOLITECITY_FILE}.gz $GEOLITECITY_URL
  gunzip ${GEOLITECITY_FILE}.gz > /dev/null

  cd $ROOT_DIR
else
  echo "       $GEOLITECITY_FILE already cached"
fi


cp "$CACHE_DIR/.geoip/$GEOLITECITY_FILE" "$BUILD_DIR/$VENDOR_DIR/share/$GEOLITECITY_FILE"
GEOIP_DB_PATH="$APP_GEOIP/share/$GEOLITECITY_FILE"


PROFILE_PATH="$BUILD_DIR/.profile.d/geo.sh"
mkdir -p $(dirname $PROFILE_PATH)
echo "export GEOIP_DB_PATH=\"$GEOIP_DB_PATH\"" >> $PROFILE_PATH
echo "export PATH=\"\$HOME/$VENDOR_DIR/libmaxminddb/bin:\$PATH\"" >> $PROFILE_PATH
echo "export LD_LIBRARY_PATH=\"\$HOME/$VENDOR_DIR/libmaxminddb/include:\$HOME/$VENDOR_DIR/libmaxminddb/lib:\$LD_LIBRARY_PATH\"" >> $PROFILE_PATH

echo "       exporting \$GEOIP_DB_PATH=$GEOIP_DB_PATH"
